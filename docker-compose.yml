services:
  pal:
    build: .
    ports:
      - "${PAL_SERVER_PORT:-8090}:${PAL_SERVER_PORT:-8090}"
    volumes:
      - ./files:/app/files
      - ${PAL_PROMPTS_DIR:-./prompts}:/app/prompts
      - ./src:/app/src
      - ~/.local/share/claude:/root/.local/share/claude:ro
      - ~/.claude:/root/.claude
    environment:
      - PAL_SERVER_PORT=${PAL_SERVER_PORT:-8090}
      - PAL_LOG_LEVEL=${PAL_LOG_LEVEL:-INFO}
      - PAL_PROMPTS_DIR=/app/prompts
      - PAL_FILES_DIR=/app/files
      - PAL_OAUTH_PUBLIC_URL=${PAL_OAUTH_PUBLIC_URL:-}
      - PAL_MEILISEARCH_URL=${PAL_MEILISEARCH_URL:-http://meilisearch:7700}
      - PAL_OLLAMA_URL=${PAL_OLLAMA_URL:-http://ollama:11434}
      - PAL_NOTES_ENABLED=${PAL_NOTES_ENABLED:-false}
      - PAL_NOTES_AI_PROVIDER=${PAL_NOTES_AI_PROVIDER:-pal-follow-up}
      - PYTHONPATH=/app/src
    restart: unless-stopped

  # Notes infrastructure (optional)
  # To enable: edit .env and set PAL_NOTES_ENABLED=true, then:
  #   docker compose --profile notes up -d
  meilisearch:
    image: getmeili/meilisearch:v1.11
    profiles: ["notes"]
    ports:
      - "7700:7700"
    volumes:
      - ${PAL_DATA_DIR:-./data}/meilisearch:/meili_data
    environment:
      - MEILI_ENV=development
      - MEILI_NO_ANALYTICS=true
      - MEILI_DB_PATH=/meili_data/data.ms
    restart: unless-stopped

  ollama:
    image: ollama/ollama:latest
    profiles: ["notes"]
    ports:
      - "11434:11434"
    volumes:
      - ${PAL_DATA_DIR:-./data}/ollama:/root/.ollama
    restart: unless-stopped

  meilisearch-ui:
    image: riccoxie/meilisearch-ui:latest
    profiles: ["notes"]
    ports:
      - "24900:24900"
    restart: unless-stopped

  meilisearch-backup:
    image: alpine:latest
    profiles: ["notes"]
    volumes:
      - ${PAL_DATA_DIR:-./data}/meilisearch:/source:ro
      - ${PAL_DATA_DIR:-./data}/meilisearch-backups:/backups
      - ./bin/meilisearch-backup.sh:/backup.sh:ro
    environment:
      - BACKUP_KEEP=20
      - BACKUP_CRON=0 2 * * *
      - SOURCE_DIR=/source
      - BACKUP_DIR=/backups
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache dcron

        # Run initial backup on startup
        /backup.sh

        # Setup cron job
        echo "$$BACKUP_CRON /backup.sh >> /var/log/backup.log 2>&1" > /etc/crontabs/root

        echo "Backup service started. Schedule: $$BACKUP_CRON (keeping last $$BACKUP_KEEP backups)"

        # Run cron in foreground
        crond -f -l 2
    restart: unless-stopped
